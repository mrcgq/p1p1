#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Phantom Server v1.1 - å‘å¸ƒå·¥ä½œæµ
#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'å‘å¸ƒç‰ˆæœ¬ (ä¾‹å¦‚: v1.1.0)'
        required: true
        type: string

env:
  GO_VERSION: '1.21'
  BINARY_NAME: phantom-server

permissions:
  contents: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # å‡†å¤‡å‘å¸ƒ
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ç¡®å®šç‰ˆæœ¬
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG="${GITHUB_REF#refs/tags/}"
          fi
          VERSION="${TAG#v}"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ å‡†å¤‡å‘å¸ƒç‰ˆæœ¬: ${VERSION} (æ ‡ç­¾: ${TAG})"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # å¤šå¹³å°æ„å»º
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build:
    name: Build (${{ matrix.os }}/${{ matrix.arch }})
    runs-on: ubuntu-latest
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: linux
            arch: amd64
            ext: ""
          - os: linux
            arch: arm64
            ext: ""
          - os: linux
            arch: arm
            goarm: "7"
            ext: ""
          - os: darwin
            arch: amd64
            ext: ""
          - os: darwin
            arch: arm64
            ext: ""
          - os: windows
            arch: amd64
            ext: ".exe"
          - os: freebsd
            arch: amd64
            ext: ""

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½® Go ç¯å¢ƒ
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶
        env:
          GOOS: ${{ matrix.os }}
          GOARCH: ${{ matrix.arch }}
          GOARM: ${{ matrix.goarm }}
          CGO_ENABLED: 0
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          COMMIT=$(git rev-parse --short HEAD)
          BUILD_TIME=$(date -u '+%Y-%m-%d %H:%M:%S')
          
          # æ„å»ºæ–‡ä»¶å
          if [[ "${{ matrix.arch }}" == "arm" ]]; then
            ARCH_SUFFIX="armv${{ matrix.goarm }}"
          else
            ARCH_SUFFIX="${{ matrix.arch }}"
          fi
          BINARY_OUTPUT="${{ env.BINARY_NAME }}-${{ matrix.os }}-${ARCH_SUFFIX}${{ matrix.ext }}"
          
          # æ„å»º
          go build -trimpath \
            -ldflags "-s -w \
              -X 'main.Version=${VERSION}' \
              -X 'main.BuildTime=${BUILD_TIME}' \
              -X 'main.GitCommit=${COMMIT}'" \
            -o "${BINARY_OUTPUT}" \
            ./cmd/phantom-server
          
          echo "BINARY_OUTPUT=${BINARY_OUTPUT}" >> $GITHUB_ENV
          echo "âœ… æ„å»ºå®Œæˆ: ${BINARY_OUTPUT}"

      - name: åˆ›å»ºå‘å¸ƒåŒ…
        run: |
          ARCHIVE_NAME="${BINARY_OUTPUT%.exe}"
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p release-package
          cp "${BINARY_OUTPUT}" release-package/
          cp configs/config.example.yaml release-package/config.yaml
          cp README.md release-package/
          cp LICENSE release-package/ 2>/dev/null || echo "# MIT License" > release-package/LICENSE
          
          # åˆ›å»ºå®‰è£…è¯´æ˜
          cat > release-package/INSTALL.txt << 'EOF'
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘              Phantom Server v${{ needs.prepare.outputs.version }} å®‰è£…æŒ‡å—              â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          1. ç§»åŠ¨äºŒè¿›åˆ¶æ–‡ä»¶åˆ°ç³»ç»Ÿç›®å½•:
             sudo mv phantom-server* /usr/local/bin/phantom-server
             sudo chmod +x /usr/local/bin/phantom-server

          2. åˆ›å»ºé…ç½®ç›®å½•:
             sudo mkdir -p /etc/phantom
             sudo mv config.yaml /etc/phantom/

          3. è¿è¡Œåˆå§‹åŒ–å‘å¯¼:
             phantom-server setup --domain your.domain.com \
                 --cf-token "your-cloudflare-token" \
                 --cf-zone-id "your-zone-id"

          4. å¯åŠ¨æœåŠ¡:
             phantom-server run -c /etc/phantom/config.yaml

          æ›´å¤šä¿¡æ¯è¯·è®¿é—®: https://github.com/anthropics/phantom-server
          EOF
          
          # æ‰“åŒ…
          if [[ "${{ matrix.os }}" == "windows" ]]; then
            zip -j "${ARCHIVE_NAME}.zip" release-package/*
            echo "ARCHIVE=${ARCHIVE_NAME}.zip" >> $GITHUB_ENV
          else
            tar -czvf "${ARCHIVE_NAME}.tar.gz" -C release-package .
            echo "ARCHIVE=${ARCHIVE_NAME}.tar.gz" >> $GITHUB_ENV
          fi

      - name: ç”Ÿæˆæ ¡éªŒå’Œ
        run: |
          sha256sum "${ARCHIVE}" > "${ARCHIVE}.sha256"
          echo "SHA256: $(cat ${ARCHIVE}.sha256)"

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.os }}-${{ matrix.arch }}
          path: |
            ${{ env.ARCHIVE }}
            ${{ env.ARCHIVE }}.sha256
          retention-days: 1

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # åˆ›å»º GitHub Release
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [prepare, build]
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: release-*

      - name: æ•´ç†å‘å¸ƒæ–‡ä»¶
        run: |
          mkdir -p release-files
          find artifacts -type f \( -name "*.tar.gz" -o -name "*.zip" -o -name "*.sha256" \) -exec mv {} release-files/ \;
          ls -la release-files/
          
          # ç”Ÿæˆæ±‡æ€»æ ¡éªŒå’Œæ–‡ä»¶
          cd release-files
          cat *.sha256 > checksums.txt
          echo "=== æ‰€æœ‰æ ¡éªŒå’Œ ==="
          cat checksums.txt

      - name: ç”Ÿæˆæ›´æ–°æ—¥å¿—
        id: changelog
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          TAG="${{ needs.prepare.outputs.tag }}"
          
          cat > release-notes.md << EOF
          # ğŸš€ Phantom Server ${TAG}
          
          ## âœ¨ æ–°ç‰¹æ€§
          
          - ğŸ¯ **Adaptive FEC** - æ™ºèƒ½åŠ¨æ€å†—ä½™ï¼Œæ ¹æ®ç½‘ç»œçŠ¶å†µè‡ªåŠ¨è°ƒæ•´
          - ğŸ”Œ **SOCKS5 UDP ASSOCIATE** - å®Œæ•´çš„ UDP ä»£ç†æ”¯æŒ
          - ğŸ”€ **å¤šè·¯å¤ç”¨** - å•è¿æ¥æ‰¿è½½å¤šæµï¼Œå‡å°‘è¿æ¥å¼€é”€
          - ğŸ“Š **å¢å¼ºæŒ‡æ ‡** - å®æ—¶ä¸¢åŒ…ç‡ã€RTTã€FEC çŠ¶æ€ç›‘æ§
          
          ## ğŸ“¦ ä¸‹è½½
          
          | å¹³å° | æ¶æ„ | ä¸‹è½½é“¾æ¥ |
          |------|------|----------|
          | Linux | amd64 | [phantom-server-linux-amd64.tar.gz](https://github.com/anthropics/phantom-server/releases/download/${TAG}/phantom-server-linux-amd64.tar.gz) |
          | Linux | arm64 | [phantom-server-linux-arm64.tar.gz](https://github.com/anthropics/phantom-server/releases/download/${TAG}/phantom-server-linux-arm64.tar.gz) |
          | Linux | armv7 | [phantom-server-linux-armv7.tar.gz](https://github.com/anthropics/phantom-server/releases/download/${TAG}/phantom-server-linux-armv7.tar.gz) |
          | macOS | amd64 | [phantom-server-darwin-amd64.tar.gz](https://github.com/anthropics/phantom-server/releases/download/${TAG}/phantom-server-darwin-amd64.tar.gz) |
          | macOS | arm64 | [phantom-server-darwin-arm64.tar.gz](https://github.com/anthropics/phantom-server/releases/download/${TAG}/phantom-server-darwin-arm64.tar.gz) |
          | Windows | amd64 | [phantom-server-windows-amd64.zip](https://github.com/anthropics/phantom-server/releases/download/${TAG}/phantom-server-windows-amd64.zip) |
          | FreeBSD | amd64 | [phantom-server-freebsd-amd64.tar.gz](https://github.com/anthropics/phantom-server/releases/download/${TAG}/phantom-server-freebsd-amd64.tar.gz) |
          
          ## ğŸ”§ å¿«é€Ÿå®‰è£…
          
          \`\`\`bash
          # Linux/macOS ä¸€é”®å®‰è£…
          bash <(curl -fsSL https://raw.githubusercontent.com/anthropics/phantom-server/main/scripts/install.sh)
          
          # æˆ–æ‰‹åŠ¨ä¸‹è½½
          wget https://github.com/anthropics/phantom-server/releases/download/${TAG}/phantom-server-linux-amd64.tar.gz
          tar -xzf phantom-server-linux-amd64.tar.gz
          sudo mv phantom-server /usr/local/bin/
          \`\`\`
          
          ## ğŸ“‹ æ ¡éªŒå’Œ
          
          <details>
          <summary>SHA256 æ ¡éªŒå’Œ</summary>
          
          \`\`\`
          $(cat release-files/checksums.txt)
          \`\`\`
          
          </details>
          
          ## ğŸ“– å®Œæ•´æ–‡æ¡£
          
          æŸ¥çœ‹ [README.md](https://github.com/anthropics/phantom-server#readme) è·å–å®Œæ•´ä½¿ç”¨è¯´æ˜ã€‚
          
          ---
          
          **Full Changelog**: https://github.com/anthropics/phantom-server/compare/$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "v1.0.0")...${TAG}
          EOF

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.prepare.outputs.tag }}
          name: Phantom Server ${{ needs.prepare.outputs.tag }}
          body_path: release-notes.md
          draft: false
          prerelease: ${{ contains(needs.prepare.outputs.tag, 'alpha') || contains(needs.prepare.outputs.tag, 'beta') || contains(needs.prepare.outputs.tag, 'rc') }}
          files: |
            release-files/*.tar.gz
            release-files/*.zip
            release-files/*.sha256
            release-files/checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # æ›´æ–°å®‰è£…è„šæœ¬
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  update-install-script:
    name: Update Install Script
    runs-on: ubuntu-latest
    needs: [prepare, release]
    if: ${{ !contains(needs.prepare.outputs.tag, 'alpha') && !contains(needs.prepare.outputs.tag, 'beta') }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: æ›´æ–°å®‰è£…è„šæœ¬ç‰ˆæœ¬
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          
          # æ›´æ–° install.sh ä¸­çš„ç‰ˆæœ¬å·
          if [ -f scripts/install.sh ]; then
            sed -i "s/^VERSION=.*/VERSION=\"${VERSION}\"/" scripts/install.sh
            echo "âœ… æ›´æ–° install.sh ç‰ˆæœ¬åˆ° ${VERSION}"
          fi

      - name: æäº¤æ›´æ”¹
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update install script to ${{ needs.prepare.outputs.tag }}"
          file_pattern: scripts/install.sh
          branch: main

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [prepare, release]
    if: always()
    steps:
      - name: å‘å¸ƒçŠ¶æ€
        run: |
          if [[ "${{ needs.release.result }}" == "success" ]]; then
            echo "âœ… Phantom Server ${{ needs.prepare.outputs.tag }} å‘å¸ƒæˆåŠŸ!"
            echo "ğŸ“¦ Release URL: https://github.com/anthropics/phantom-server/releases/tag/${{ needs.prepare.outputs.tag }}"
          else
            echo "âŒ å‘å¸ƒå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
            exit 1
          fi

      # å¯é€‰ï¼šå‘é€åˆ° Telegram/Discord/Slack
      # - name: å‘é€ Telegram é€šçŸ¥
      #   if: ${{ needs.release.result == 'success' && secrets.TELEGRAM_BOT_TOKEN }}
      #   uses: appleboy/telegram-action@master
      #   with:
      #     to: ${{ secrets.TELEGRAM_CHAT_ID }}
      #     token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      #     message: |
      #       ğŸš€ Phantom Server ${{ needs.prepare.outputs.tag }} å·²å‘å¸ƒ!
      #       
      #       ğŸ“¦ ä¸‹è½½: https://github.com/anthropics/phantom-server/releases/tag/${{ needs.prepare.outputs.tag }}
